# M5StickC Plus2 CO2モニター（堅牢版）

**作者**: omiya-bonsai

M5StickC Plus2とCO2センサーを使用した24/7運用対応の環境監視システムです。

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

## 機能

### 基本機能
- CO2濃度の測定と表示
- 温度・湿度の表示
- WiFi接続とNTP時刻同期
- MQTT経由でのデータ送信

### 堅牢性機能（24/7運用対応）
- **自動再起動**: 24時間ごとの定期再起動
- **接続監視**: WiFi・MQTT接続の自動復旧
- **異常値検知**: センサーデータの範囲チェック
- **メモリ監視**: ヒープメモリ不足の検知
- **ヘルスチェック**: 5分ごとのシステム状態確認
- **エラーカウンター**: 連続エラーでの自動再起動
- **システム統計**: 稼働時間・メモリ使用量の報告
- **緊急時ログ**: 再起動理由のMQTT送信

## セットアップ手順

### 1. 設定ファイルの準備

`config_example.h`を`config.h`にコピーして、あなたの環境に合わせて設定を変更してください：

```bash
cp config_example.h config.h
```

### 2. config.hの編集

`config.h`ファイルを開いて、以下の設定を変更してください：

#### 基本設定
- `ssid`: あなたのWiFiネットワークのSSID
- `password`: あなたのWiFiネットワークのパスワード  
- `mqtt_server`: MQTTブローカーのIPアドレス
- その他のMQTT設定（必要に応じて）

#### 堅牢性設定（24/7運用向け）
- `AUTO_RESTART_INTERVAL`: 自動再起動間隔（デフォルト：24時間）
- `ENABLE_AUTO_RESTART`: 自動再起動の有効/無効
- `ENABLE_WATCHDOG`: ウォッチドッグタイマーの有効/無効
- `MAX_WIFI_RETRY`: WiFi接続最大リトライ回数
- `MAX_MQTT_RETRY`: MQTT接続最大リトライ回数
- `SENSOR_TIMEOUT`: センサーデータ取得タイムアウト
- `MIN_FREE_HEAP`: 最低空きヒープメモリ閾値

### 3. ライブラリの準備

Arduino IDEで以下のライブラリをインストールしてください：

- M5StickCPlus2
- M5UnitENV
- PubSubClient

### 4. ハードウェア接続

- CO2センサーユニットをM5StickC Plus2のGroveポートに接続
- 電源を接続（24/7運用の場合は安定した電源を推奨）

### 5. プログラムの書き込み

Arduino IDEでプログラムをコンパイル・書き込みしてください。

## データ形式

### センサーデータ
MQTTで送信されるセンサーデータはJSON形式です：

```json
{
  "time": "14:30:15",
  "co2": 450,
  "temp": 23.5,
  "hum": 55.2
}
```

### システム統計データ
```json
{
  "type": "system",
  "uptime": 86400,
  "free_heap": 180000,
  "wifi_rssi": -45,
  "sensor_errors": 0
}
```

### アラート・再起動ログ
```json
{
  "type": "restart",
  "reason": "Scheduled restart"
}
```

## MQTTトピック

- `m5stickc_co2/co2_data`: センサーデータ
- `m5stickc_co2/co2_data/system`: システム統計
- `m5stickc_co2/co2_data/alert`: アラート・再起動ログ

## 表示インジケーター

### 画面表示
- CO2濃度：中央に大きく表示（色分け：緑=良好、黄=注意、赤=危険）
- 温度・湿度：下部に表示
- 時刻：上部右側に表示
- システム健全性：右上の小さな円（赤=異常検知時）

### シリアルモニター
- センサーデータ（CO2、温度、湿度）
- 稼働時間・空きメモリ
- ヘルスチェック結果
- エラー・警告メッセージ

## 24/7運用のベストプラクティス

1. **電源の安定化**: UPSや安定した電源アダプターを使用
2. **熱対策**: 適切な通気を確保
3. **監視**: MQTT経由でのリモート監視体制を構築
4. **ログ収集**: システム統計とアラートの定期的な確認
5. **メンテナンス**: センサーの定期的な校正・清掃

## トラブルシューティング

### よくある問題

1. **WiFi接続が不安定**
   - ルーターとの距離を確認
   - チャンネル干渉を避ける
   - 2.4GHz帯域の確認

2. **センサーエラーが頻発**
   - I2C配線の確認
   - センサーの清掃
   - 電源ノイズの確認

3. **メモリ不足**
   - 長時間運用でのメモリリーク
   - 自動再起動で解決される場合が多い

## 注意事項

- `config.h`ファイルには個人情報が含まれるため、Gitリポジトリにコミットしないでください
- センサーの初期化には数秒かかる場合があります
- 24/7運用時は定期的なシステム確認を推奨します

## 作者・謝辞

### 作者
**omiya-bonsai**

### 開発協力
このプロジェクトの堅牢性機能の設計・実装において、**Claude (Anthropic AI)** からの技術的支援を受けました。特に以下の分野で貢献いただきました：

- 24/7運用に向けた堅牢性アーキテクチャの設計
- エラーハンドリングとフェイルセーフ機能の実装
- システムヘルスモニタリング機能の開発
- コード構造化とドキュメント整備

### 使用技術・ライブラリ
- **M5StickC Plus2**: メインハードウェアプラットフォーム
- **M5UnitENV**: 環境センサーライブラリ
- **PubSubClient**: MQTT通信ライブラリ
- **ESP32 Arduino Core**: 基盤フレームワーク

## ライセンス

このプロジェクトは [MIT License](LICENSE) の下で公開されています。
